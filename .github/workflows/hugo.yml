# æ„å»ºå¹¶å°† Hugo ç«™ç‚¹éƒ¨ç½²åˆ° GitHub Pages çš„ç¤ºä¾‹å·¥ä½œæµ
name: éƒ¨ç½²Hugoç«™ç‚¹åˆ°GitHub Pages

on:
  # åœ¨é’ˆå¯¹é»˜è®¤åˆ†æ”¯çš„æ¨é€ä¸Šè¿è¡Œ
  push:
    branches:
      - main

  # å…è®¸ä½ ä» Actions é€‰é¡¹å¡æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN çš„æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡åœ¨è¿›è¡Œä¸­çš„è¿è¡Œå’Œæœ€æ–°æ’é˜Ÿçš„è¿è¡Œä¹‹é—´æ’é˜Ÿçš„è¿è¡Œã€‚
# ä½†æ˜¯ï¼Œä¸è¦å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬è¦å…è®¸è¿™äº›ç”Ÿäº§éƒ¨ç½²å®Œæˆã€‚
concurrency:
  group: "pages"
  cancel-in-progress: false

# é»˜è®¤ä¸º bash
defaults:
  run:
    shell: bash

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    env:
      HUGO_VERSION: 0.139.4
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç åº“
      # åŒ…æ‹¬é€’å½’è·å–å­æ¨¡å—ï¼Œfetching-depth: 0 è¡¨ç¤ºè·å–å®Œæ•´å†å²ï¼ˆHugoæ„å»ºå¯èƒ½éœ€è¦Gitä¿¡æ¯ï¼‰
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          
      # ğŸ‘‡ æ–°å¢ï¼šå¼ºåˆ¶åˆå§‹åŒ–å¹¶æ›´æ–°æ‰€æœ‰å­æ¨¡å—
      # ç¡®ä¿ä¸»é¢˜ç­‰å­æ¨¡å—æ–‡ä»¶è¢«å®Œæ•´ä¸‹è½½
      - name: Initialize submodules
        run: git submodule update --init --recursive

      # 2. å®‰è£… Hugo ç¯å¢ƒ
      # ä½¿ç”¨ peaceiris/actions-hugo åŠ¨ä½œï¼Œextended: true è¡¨ç¤ºæ”¯æŒ Sass/SCSS
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # 3. é…ç½® GitHub Pages
      # ç”¨äºç”Ÿæˆ build æ—¶çš„ metadataï¼Œä¾› Hugo ä½¿ç”¨
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      # 4. æ„å»º Hugo ç«™ç‚¹
      # --gc: æ„å»ºå‰è¿è¡Œåƒåœ¾å›æ”¶
      # --minify: å‹ç¼©è¾“å‡ºæ–‡ä»¶
      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
          TZ: Asia/Shanghai # è®¾ç½®æ—¶åŒºï¼Œç¡®ä¿æ—¥æœŸæ—¶é—´æ­£ç¡®
        run: |
          hugo \
            --gc \
            --minify

      # 5. æ£€æŸ¥æ„å»ºäº§ç‰©
      # ç®€å•éªŒè¯ index.html æ˜¯å¦ç”Ÿæˆï¼Œé˜²æ­¢ç©ºéƒ¨ç½²
      - name: Check build output
        run: ls -R public/index.html

      # 6. ä¸Šä¼ æ„å»ºå¥½çš„é™æ€æ–‡ä»¶
      # æ­¤æ—¶æ–‡ä»¶ä¼šè¢«æ‰“åŒ…æˆ Artifact ä¾› deploy job ä½¿ç”¨
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # éƒ¨ç½²ä»»åŠ¡
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build # ä¾èµ–äº build ä»»åŠ¡
    steps:
      # 7. éƒ¨ç½²åˆ° GitHub Pages
      # ä» artifact ä¸­è·å–æ–‡ä»¶å¹¶æ¨é€
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
