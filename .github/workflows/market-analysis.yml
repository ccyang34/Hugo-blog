name: 多AI分析文件运行

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: '30 7 * * 1-5'
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  LANG: zh_CN.UTF-8

jobs:
  analysis:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        script:
          - "分析文章脚本/AI油脂期货分析师_增强版.py"
          - "分析文章脚本/榨利计算深度分析_v3.py"
          - "分析文章脚本/AI市场宽度分析师_v4.py"
          - "分析文章脚本/AI行业分析师.py"
          - "分析文章脚本/豆油持仓价格榨利分析.py"
    
    steps:
    - name: 检出代码（只拉取脚本，不拉取历史文章）
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          分析文章脚本
        sparse-checkout-cone-mode: false
      
    - name: 创建输出目录
      run: |
        mkdir -p content/posts
        mkdir -p static/images/charts
        
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装中文字体
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-wqy-microhei
        fc-cache -fv
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests akshare pytz matplotlib beautifulsoup4 lxml
        
    - name: 运行分析脚本
      run: |
        python "${{ matrix.script }}"
      env:
        HUGO_BLOG_DIR: "."
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

    - name: 显示生成的文件
      run: |
        echo "=== 生成的报告 ==="
        ls -la content/posts/ || echo "无报告文件"
        echo "=== 生成的图表 ==="
        ls -la static/images/charts/ || echo "无图表文件"

    - name: 上传生成的报告和图表
      uses: actions/upload-artifact@v4
      with:
        name: reports-${{ strategy.job-index }}
        path: |
          content/posts/*
          static/images/charts/*
        retention-days: 1
        if-no-files-found: warn

  publish:
    needs: analysis
    runs-on: ubuntu-latest
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 下载所有分析结果
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: reports-*
        merge-multiple: false

    - name: 调试 - 查看 Artifact 结构
      run: |
        echo "=== Artifact 目录完整结构 ==="
        find artifacts -type f
        echo ""
        echo "=== 找到的 .md 文件 ==="
        find artifacts -name "*.md" -type f
        echo ""
        echo "=== 找到的图表文件 ==="
        find artifacts \( -name "*.png" -o -name "*.jpg" -o -name "*.svg" -o -name "*.html" \) -type f

    - name: 汇总并移动文件
      run: |
        # 确保目标目录存在
        mkdir -p content/posts static/images/charts
        
        # 遍历所有下载的 artifact 并移动内容
        echo "=== 开始移动报告文件 ==="
        find artifacts -name "*.md" -type f -exec cp -fv {} content/posts/ \;
        
        echo "=== 开始移动图表文件 ==="
        find artifacts \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" -o -name "*.webp" \) -type f -exec cp -fv {} static/images/charts/ \;
        find artifacts -name "*.html" -type f -exec cp -fv {} static/images/charts/ \; 2>/dev/null || true
        
        echo "=== 移动后 content/posts 目录内容 ==="
        ls -la content/posts/ | grep -E "油脂|榨利|宽度|行业|豆油" || echo "未找到分析报告"

    - name: 提交并推送生成的报告
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        
        # 精确添加生成的文件，避免误删或漏加
        git add content/posts/*.md
        git add static/images/charts/* || true
        if git diff --staged --quiet; then
          echo "没有新文件需要提交"
        else
          git commit -m "Auto-generated: Multi-Market AI Analysis Reports (Parallel) [skip ci]"
          git push
        fi
        
    - name: 触发部署 (Trigger Deploy)
      if: success()
      run: gh workflow run hugo.yml
      env:
        GH_TOKEN: ${{ github.token }}
        
