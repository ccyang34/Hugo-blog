name: 多AI分析文件运行

permissions:
  contents: write       # 允许写入仓库内容
  actions: write        # 允许触发其他 workflow
  # 如果后续需要部署到其他仓库，可以添加:
  # contents: write      # 写入仓库内容
  # pull-requests: write # 写入PR

on:
  schedule:
    - cron: '30 7 * * 1-5'  # 每天收盘后运行 (UTC时间上午7:30，即北京时间下午3:30)
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装中文字体
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-wqy-microhei
        fc-cache -fv
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests akshare pytz matplotlib
        
    - name: 运行油脂期货分析
      run: |
        python "分析文章脚本/AI油脂期货分析师_增强版.py"
      env:
        HUGO_BLOG_DIR: "."
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

    - name: 运行榨利计算深度分析
      run: |
        python "分析文章脚本/榨利计算深度分析_v3.py"
      env:
        HUGO_BLOG_DIR: "."
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        
    - name: 检查执行状态
      run: |
        if [ $? -eq 0 ]; then
          echo "✅ 油脂期货分析完成"
          # 检查生成的Hugo博客文件
          if ls content/posts/*.md 1> /dev/null 2>&1; then
            echo "✅ Hugo博客文件生成成功"
            ls -l content/posts/*.md
          else
            echo "⚠️ 未找到Hugo博客文件"
          fi
        else
          echo "❌ 油脂期货分析失败"
          exit 1
        fi
        
    - name: 提交并推送生成的报告
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add content/posts/*.md
        git add static/images/*.png
        git add static/img/charts/*.png
        if git diff --staged --quiet; then
          echo "没有新文件需要提交"
        else
          git commit -m "Auto-generated: Futures & Crush Margin Analysis Report [skip ci]"
          git push
        fi
        
    - name: 触发部署 (Trigger Deploy)
      if: success()
      run: gh workflow run hugo.yml
      env:
        GH_TOKEN: ${{ github.token }}
        
