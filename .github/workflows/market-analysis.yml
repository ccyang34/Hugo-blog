name: 多AI分析文件运行

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: '30 7 * * 1-5'
  workflow_dispatch:

jobs:
  analysis:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        script:
          - "分析文章脚本/AI油脂期货分析师_增强版.py"
          - "分析文章脚本/榨利计算深度分析_v3.py"
          - "分析文章脚本/AI市场宽度分析师_v4.py"
          - "分析文章脚本/AI行业分析师.py"
          - "分析文章脚本/豆油持仓价格榨利分析.py"
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装中文字体
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-wqy-microhei
        fc-cache -fv
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests akshare pytz matplotlib beautifulsoup4 lxml
        
    - name: 运行分析脚本
      run: |
        python "${{ matrix.script }}"
      env:
        HUGO_BLOG_DIR: "."
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

    - name: 上传生成的报告和图表
      uses: actions/upload-artifact@v4
      with:
        name: reports-${{ strategy.job-index }}
        path: |
          content/posts/*.md
          static/images/charts/*.png
        retention-days: 1

  publish:
    needs: analysis
    runs-on: ubuntu-latest
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 下载所有分析结果
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: reports-*
        merge-multiple: true

    - name: 汇总并移动文件
      run: |
        # 将下载的文件移动到正确的位置
        if [ -d "artifacts/content/posts" ]; then
          cp -rn artifacts/content/posts/* content/posts/
        fi
        if [ -d "artifacts/static/images/charts" ]; then
          cp -rn artifacts/static/images/charts/* static/images/charts/
        fi
        
    - name: 提交并推送生成的报告
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add content/posts/*.md
        git add static/images/charts/*.png
        if git diff --staged --quiet; then
          echo "没有新文件需要提交"
        else
          git commit -m "Auto-generated: Multi-Market AI Analysis Reports (Parallel) [skip ci]"
          git push
        fi
        
    - name: 触发部署 (Trigger Deploy)
      if: success()
      run: gh workflow run hugo.yml
      env:
        GH_TOKEN: ${{ github.token }}
        
