{{ define "body-class" }}template-search{{ end }}
{{ define "head" }}
{{- with .OutputFormats.Get "json" -}}
<link rel="preload" href="{{ .RelPermalink }}" as="fetch" crossorigin="anonymous">
{{- end -}}
<style>
    .cf-status-card {
        margin: -10px 0 0px 0;
        padding: 5px 14px;
        border-radius: 12px;
        background: var(--card-background, #fff);
        border: 1px solid var(--line-color, #eee);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s;
    }

    .search-form {
        margin-top: 5px !important;
    }

    .status-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ccc;
        box-shadow: 0 0 0 3px rgba(204, 204, 204, 0.2);
    }

    .status-dot.success {
        background: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .status-dot.failure {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }

    .status-dot.progress {
        background: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(0.95);
            opacity: 0.7;
        }

        50% {
            transform: scale(1.05);
            opacity: 1;
        }

        100% {
            transform: scale(0.95);
            opacity: 0.7;
        }
    }

    .status-label {
        font-size: 0.8rem;
        color: #888;
        margin-bottom: 2px;
    }

    #status-text {
        font-weight: 700;
        color: var(--card-text-color, #333);
        font-size: 1.1rem;
    }

    #check-status-btn,
    .deploy-btn {
        background: #f38020;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        border: none !important;
        font-size: 0.9rem;
    }

    .deploy-btn {
        background: #0070f3 !important;
        /* Vercel Blue / Professional Blue */
    }

    .status-actions {
        display: flex;
        gap: 8px;
    }

    #check-status-btn:active,
    .deploy-btn:active {
        transform: scale(0.95);
    }

    #check-status-btn:disabled,
    .deploy-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media screen and (max-width: 767px) {
        .cf-status-card {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 14px;
        }

        .status-actions {
            width: 100%;
            justify-content: space-between;
        }

        #check-status-btn,
        .deploy-btn {
            flex: 1;
            justify-content: center;
        }
    }
</style>
{{ end }}

{{ define "main" }}
<div class="cf-status-card">
    <div class="status-info">
        <div id="status-dot" class="status-dot"></div>
        <div>
            <div class="status-label">Cloudflare Pages 部署状态</div>
            <div id="status-text">待查询</div>
        </div>
    </div>
    <div class="status-actions">
        <button id="deploy-btn" class="deploy-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg>
            <span>立即部署</span>
        </button>
        <button id="check-status-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 4v6h-6" />
                <path d="M1 20v-6h6" />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
            </svg>
            <span>刷新反馈</span>
        </button>
    </div>
</div>

<form action="{{ .RelPermalink }}" class="search-form" {{ with .OutputFormats.Get "json" -}}
    data-json="{{ .RelPermalink }}" {{- end }}>
    <p>
        <label>{{ T "search.title" }}</label>
        <input name="keyword" placeholder="{{ T `search.placeholder` }}" />
    </p>

    <button title="{{ T `search.title` }}">
        {{ partial "helper/icon" "search" }}
    </button>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list article-list--compact"></div>
</div>

<script>
    window.searchResultTitleTemplate = "{{ T `search.resultTitle` }}";

    (function () {
        const btn = document.getElementById('check-status-btn');
        const deployBtn = document.getElementById('deploy-btn');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const PROXY_URL = "https://status.ccyang.online";
        const DEPLOY_HOOK = "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/3a05327c-b7d8-4d2f-9c94-e8d520941d29";

        async function fetchStatus() {
            btn.disabled = true;
            statusText.innerText = "正在查询...";
            statusDot.className = "status-dot progress";

            try {
                const response = await fetch(PROXY_URL);
                if (!response.ok) throw new Error('Proxy 请求失败');

                const data = await response.json();
                if (data.success && data.result.length > 0) {
                    const latest = data.result[0];
                    const status = latest.latest_stage.status;
                    const time = new Date(latest.created_on).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    statusText.innerHTML = `${status.toUpperCase()} <span style="font-size:0.8rem; font-weight:normal; color:#999; margin-left:8px;">${time} 更新</span>`;

                    if (status === 'success') {
                        statusDot.className = "status-dot success";
                    } else if (status === 'failure') {
                        statusDot.className = "status-dot failure";
                    } else if (status === 'building' || status === 'active' || status === 'in_progress') {
                        statusDot.className = "status-dot progress";
                    } else {
                        statusDot.className = "status-dot";
                    }
                } else {
                    statusText.innerText = "数据解析异常";
                    statusDot.className = "status-dot";
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "查询失败 (检查 Worker)";
                statusDot.className = "status-dot failure";
            } finally {
                btn.disabled = false;
                btn.querySelector('span').innerText = "刷新反馈";
            }
        }

        async function triggerDeploy() {
            if (!confirm("确定要立即重新部署博客吗？")) return;

            deployBtn.disabled = true;
            deployBtn.querySelector('span').innerText = "提交中...";

            try {
                const response = await fetch(DEPLOY_HOOK, { method: 'POST' });
                if (response.ok) {
                    statusText.innerText = "部署已触发...";
                    statusDot.className = "status-dot progress";
                    alert("✅ 部署请求已发送！Cloudflare 正在开始构建。");
                    // 延迟3秒后刷新状态
                    setTimeout(fetchStatus, 3000);
                } else {
                    alert("❌ 部署触发失败，请检查 Hook URL。");
                }
            } catch (error) {
                console.error(error);
                alert("⚠️ 网络错误，无法连接到 Cloudflare。");
            } finally {
                deployBtn.disabled = false;
                deployBtn.querySelector('span').innerText = "立即部署";
            }
        }

        btn.addEventListener('click', fetchStatus);
        deployBtn.addEventListener('click', triggerDeploy);

        // 自动查询一次
        fetchStatus();
    })();
</script>

{{- $opts := dict "minify" hugo.IsProduction "JSXFactory" "createElement" -}}
{{- $searchScript := resources.Get "ts/search.tsx" | js.Build $opts -}}
<script type="text/javascript" src="{{ $searchScript.RelPermalink }}" defer></script>

{{ partialCached "footer/footer" . }}
{{ end }}