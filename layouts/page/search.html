{{ define "body-class" }}template-search{{ end }}
{{ define "head" }}
{{- with .OutputFormats.Get "json" -}}
<link rel="preload" href="{{ .RelPermalink }}" as="fetch" crossorigin="anonymous">
{{- end -}}
<style>
    .cf-status-card {
        margin: -10px 0 0px 0;
        padding: 16px;
        border-radius: 12px;
        background: var(--card-background, #fff);
        border: 1px solid var(--line-color, #eee);
        display: flex;
        flex-direction: column;
        gap: 16px;
        transition: all 0.3s;
    }

    .search-form {
        margin-top: 20px !important;
    }

    .status-container {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .status-item {
        flex: 1;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .status-divider {
        width: 1px;
        height: 24px;
        background: #eee;
        margin: 0 16px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #d1d5db;
        /* 默认灰色 */
        display: inline-block;
        flex-shrink: 0;
        margin-top: 5px;
    }

    .status-dot.success {
        background-color: #10b981;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }

    .status-dot.progress {
        background-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        animation: pulse 2s infinite;
    }

    .status-dot.failure {
        background-color: #ef4444;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    .status-dot.unknown {
        background-color: #9ca3af;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.6;
            transform: scale(0.95);
        }

        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .status-content {
        display: flex;
        flex-direction: column;
    }

    .status-label {
        font-size: 0.7rem;
        color: #888;
        margin-bottom: 2px;
    }

    .status-value {
        font-weight: 700;
        color: var(--card-text-color, #333);
        font-size: 0.95rem;
        line-height: 1.2;
    }

    .status-value span {
        display: none;
        /* Hide timestamp for compact view */
    }

    .status-actions {
        display: flex;
        gap: 12px;
        margin-top: 0;
    }

    #check-status-btn,
    .deploy-btn {
        background: #f38020;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border: none !important;
        font-size: 0.9rem;
        flex: 1;
    }

    .deploy-btn {
        background: #2563eb !important;
        /* Slightly darker blue */
    }

    #check-status-btn:active,
    .deploy-btn:active {
        transform: scale(0.95);
    }

    #check-status-btn:disabled,
    .deploy-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media screen and (max-width: 480px) {
        .status-container {
            align-items: flex-start;
        }

        .status-item {
            flex-direction: column;
            gap: 6px;
        }

        .status-dot {
            margin-top: 2px;
        }
    }
</style>
{{ end }}

{{ define "main" }}
<div class="cf-status-card">
    <div class="status-container">
        <!-- Cloudflare -->
        <div class="status-item">
            <div id="status-dot" class="status-dot"></div>
            <div class="status-content">
                <div class="status-label">Cloudflare Pages</div>
                <div id="status-text" class="status-value">待查询</div>
            </div>
        </div>

        <div class="status-divider"></div>

        <!-- GitHub -->
        <div class="status-item">
            <div id="gh-status-dot" class="status-dot"></div>
            <div class="status-content">
                <div class="status-label">GitHub Actions</div>
                <div id="gh-status-text" class="status-value">初始化...</div>
            </div>
        </div>
    </div>

    <div class="status-actions">
        <button id="deploy-btn" class="deploy-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg>
            <span>CF手动部署</span>
        </button>
        <button id="check-status-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 4v6h-6" />
                <path d="M1 20v-6h6" />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
            </svg>
            <span>刷新</span>
        </button>
    </div>
</div>

<form action="{{ .RelPermalink }}" class="search-form" {{ with .OutputFormats.Get "json" -}}
    data-json="{{ .RelPermalink }}" {{- end }}>
    <p>
        <label>{{ T "search.title" }}</label>
        <input name="keyword" placeholder="{{ T `search.placeholder` }}" />
    </p>

    <button title="{{ T `search.title` }}">
        {{ partial "helper/icon" "search" }}
    </button>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list article-list--compact"></div>
</div>

<script>
    window.searchResultTitleTemplate = "{{ T `search.resultTitle` }}";

    (function () {
        const btn = document.getElementById('check-status-btn');
        const deployBtn = document.getElementById('deploy-btn');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const PROXY_URL = "https://status.ccyang.online";
        const DEPLOY_HOOK = "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/3a05327c-b7d8-4d2f-9c94-e8d520941d29";

        // GitHub Status Elements
        const ghStatusText = document.getElementById('gh-status-text');
        const ghStatusDot = document.getElementById('gh-status-dot');

        async function fetchStatus() {
            // Update CF UI
            statusText.innerText = "正在查询...";
            statusDot.className = "status-dot progress";

            try {
                const response = await fetch(PROXY_URL);
                if (!response.ok) throw new Error('Proxy 请求失败');

                const data = await response.json();
                if (data.success && data.result.length > 0) {
                    const latest = data.result[0];
                    const status = latest.latest_stage.status;
                    const time = new Date(latest.created_on).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    statusText.innerHTML = `${status.toUpperCase()} <span style="font-size:0.8rem; font-weight:normal; color:#999; margin-left:8px;">${time} 更新</span>`;

                    if (status === 'success') {
                        statusDot.className = "status-dot success";
                    } else if (status === 'failure') {
                        statusDot.className = "status-dot failure";
                    } else if (status === 'building' || status === 'active' || status === 'in_progress') {
                        statusDot.className = "status-dot progress";
                    } else {
                        statusDot.className = "status-dot";
                    }
                } else {
                    statusText.innerText = "数据解析异常";
                    statusDot.className = "status-dot";
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "查询失败 (检查 Worker)";
                statusDot.className = "status-dot failure";
            }
        }

        async function fetchGitHubStatus() {
            // Update GH UI
            ghStatusText.innerText = "Checking...";
            ghStatusDot.className = "status-dot progress";

            const BACKEND_API_URL = 'https://hugo-fabu.ccyang.online';

            try {
                const response = await fetch(`${BACKEND_API_URL}/api/github-status`);
                const data = await response.json();

                if (data.success && data.result) {
                    const status = (data.result.status || 'unknown').toLowerCase();
                    const conclusion = (data.result.conclusion || '').toLowerCase();

                    let displayStatus = status.toUpperCase();
                    let dotClass = 'progress'; // 默认为进行中/蓝色

                    // 状态映射逻辑
                    if (status === 'completed') {
                        displayStatus = conclusion.toUpperCase();
                        if (conclusion === 'success') {
                            dotClass = 'success';
                        } else if (conclusion === 'failure' || conclusion === 'timed_out' || conclusion === 'cancelled') {
                            dotClass = 'failure';
                        } else {
                            dotClass = 'unknown';
                        }
                    } else if (status === 'in_progress' || status === 'queued') {
                        const activeCount = data.result.active_count || 1;
                        displayStatus = activeCount > 1 ? `RUNNING (${activeCount})` : 'RUNNING';
                        dotClass = 'progress';
                    } else {
                        // 其他状态 (waiting, requested, etc.)
                        dotClass = 'unknown';
                    }

                    // 更新 UI
                    ghStatusText.textContent = displayStatus;
                    ghStatusDot.className = `status-dot ${dotClass}`;

                } else {
                    ghStatusText.textContent = 'UNKNOWN';
                    ghStatusDot.className = 'status-dot unknown';
                }
            } catch (error) {
                console.warn('[GitHub Widget] Fetch failed:', error);
                ghStatusText.textContent = 'ERROR';
                ghStatusDot.className = 'status-dot failure';
            }
        }

        async function fetchAllStatus() {
            btn.disabled = true;
            btn.querySelector('span').innerText = "刷新中...";

            await Promise.allSettled([fetchStatus(), fetchGitHubStatus()]);

            btn.disabled = false;
            btn.querySelector('span').innerText = "刷新";
        }

        async function triggerDeploy() {
            if (!confirm("确定要立即重新部署博客吗？")) return;

            deployBtn.disabled = true;
            deployBtn.querySelector('span').innerText = "提交中...";

            try {
                const response = await fetch(DEPLOY_HOOK, { method: 'POST' });
                if (response.ok) {
                    alert("✅ 部署请求已发送！Cloudflare 正在开始构建。");
                    // 延迟3秒后自动刷新
                    setTimeout(fetchAllStatus, 3000);
                } else {
                    alert("❌ 部署触发失败，请检查 Hook URL。");
                }
            } catch (error) {
                console.error(error);
                alert("⚠️ 网络错误，无法连接到 Cloudflare。");
            } finally {
                deployBtn.disabled = false;
                deployBtn.querySelector('span').innerText = "CF手动部署";
            }
        }

        btn.addEventListener('click', fetchAllStatus);
        deployBtn.addEventListener('click', triggerDeploy);

        // 自动查询一次
        fetchAllStatus();
    })();
</script>

{{- $opts := dict "minify" hugo.IsProduction "JSXFactory" "createElement" -}}
{{- $searchScript := resources.Get "ts/search.tsx" | js.Build $opts -}}
<script type="text/javascript" src="{{ $searchScript.RelPermalink }}" defer></script>

{{ partialCached "footer/footer" . }}
{{ end }}