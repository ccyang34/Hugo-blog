{{ define "body-class" }}template-search{{ end }}
{{ define "head" }}
{{- with .OutputFormats.Get "json" -}}
<link rel="preload" href="{{ .RelPermalink }}" as="fetch" crossorigin="anonymous">
{{- end -}}
<style>
    .cf-status-card {
        margin: 20px 0;
        padding: 16px;
        border-radius: 12px;
        background: #fff;
        border: 1px solid #eee;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s;
    }

    .status-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ccc;
        box-shadow: 0 0 0 3px rgba(204, 204, 204, 0.2);
    }

    .status-dot.success {
        background: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .status-dot.failure {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }

    .status-dot.progress {
        background: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(0.95);
            opacity: 0.7;
        }

        50% {
            transform: scale(1.05);
            opacity: 1;
        }

        100% {
            transform: scale(0.95);
            opacity: 0.7;
        }
    }

    .status-label {
        font-size: 0.8rem;
        color: #888;
        margin-bottom: 2px;
    }

    #status-text {
        font-weight: 700;
        color: #333;
        font-size: 1.1rem;
    }

    #check-status-btn {
        background: #f38020;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }

    #check-status-btn:active {
        transform: scale(0.95);
    }

    #check-status-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{{ end }}

{{ define "main" }}
<div class="cf-status-card">
    <div class="status-info">
        <div id="status-dot" class="status-dot"></div>
        <div>
            <div class="status-label">Cloudflare Pages 部署状态</div>
            <div id="status-text">待查询</div>
        </div>
    </div>
    <button id="check-status-btn">查询最新反馈</button>
</div>

<form action="{{ .RelPermalink }}" class="search-form" {{ with .OutputFormats.Get "json" -}}
    data-json="{{ .RelPermalink }}" {{- end }}>
    <p>
        <label>{{ T "search.title" }}</label>
        <input name="keyword" placeholder="{{ T `search.placeholder` }}" />
    </p>

    <button title="{{ T `search.title` }}">
        {{ partial "helper/icon" "search" }}
    </button>
</form>

<div class="search-result">
    <h3 class="search-result--title section-title"></h3>
    <div class="search-result--list article-list--compact"></div>
</div>

<script>
    window.searchResultTitleTemplate = "{{ T `search.resultTitle` }}";

    (function () {
        const btn = document.getElementById('check-status-btn');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');

        const TOKEN = "JWCehYmhU4bNVR2Oelczu0Q94b2C-cZrboDTOC1P";
        const ACCOUNT_ID = "274b1e425b9e2ec290178852f3798ac8";
        const PROJECT_NAME = "hugo-blog";

        async function fetchStatus() {
            btn.disabled = true;
            statusText.innerText = "正在查询...";
            statusDot.className = "status-dot progress";

            try {
                // 注意：由于浏览器 CORS 限制，直接请求 api.cloudflare.com 可能会失败。
                // 如果失败，通常需要通过 Cloudflare Worker 中转。
                const response = await fetch(`https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/deployments`, {
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('API 请求失败');

                const data = await response.json();
                if (data.success && data.result.length > 0) {
                    const latest = data.result[0];
                    const status = latest.latest_stage.status;
                    const time = new Date(latest.created_on).toLocaleString();

                    statusText.innerHTML = `${status.toUpperCase()} <span style="font-size:0.8rem; font-weight:normal; color:#999; margin-left:8px;">${time}</span>`;

                    if (status === 'success') {
                        statusDot.className = "status-dot success";
                    } else if (status === 'failure') {
                        statusDot.className = "status-dot failure";
                    } else {
                        statusDot.className = "status-dot progress";
                    }
                } else {
                    statusText.innerText = "无法获取部署信息";
                    statusDot.className = "status-dot";
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "查询出错 (可能受 CORS 限制)";
                statusDot.className = "status-dot failure";
                alert("由于 Cloudflare API 的安全限制（CORS），浏览器可能无法直接查询。如果多次尝试失败，建议使用脚本或 Worker 代理方式。");
            } finally {
                btn.disabled = false;
                btn.innerText = "刷新反馈";
            }
        }

        btn.addEventListener('click', fetchStatus);
        // 页面加载后自动尝试查询一次
        // fetchStatus(); 
    })();
</script>

{{- $opts := dict "minify" hugo.IsProduction "JSXFactory" "createElement" -}}
{{- $searchScript := resources.Get "ts/search.tsx" | js.Build $opts -}}
<script type="text/javascript" src="{{ $searchScript.RelPermalink }}" defer></script>

{{ partialCached "footer/footer" . }}
{{ end }}